<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vapi AI Assistant</title>
    <!-- Include the Vapi SDK -->
    <script src="https://cdn.vapiai.com/web/vapi.min.js"></script>
</head>
<body>
    <script>
        // Your assistant code here
        // Ensure that you wait for the SDK to load before using `vapi`

        function getQueryParam(param) {
            let urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Retrieve parameters from the query string
        const apiKey = getQueryParam('apiKey') || 'defaultApi';
        const assistant = getQueryParam('assistant') || 'defaultAssistant';
        const parentOrigin = getQueryParam('parentOrigin') || '*';

        // Set the apiKey for the Vapi SDK
        vapi.apiKey = apiKey;

        // Function to start the assistant
        function startAssistant() {
            console.log("Assistant: Starting conversation via vapi.start()");
            vapi.start(assistant);
        }

        // Event listener for messages from the parent window
        window.addEventListener('message', function(event) {
            if (event.origin !== parentOrigin) {
                console.warn("Received message from unknown origin:", event.origin);
                return;
            }

            var data = event.data;
            if (typeof data === 'object' && data !== null) {
                if (data.type === 'start_conversation') {
                    startAssistant();
                } else if (data.type === 'stop_conversation') {
                    console.log("Assistant: Stopping conversation via vapi.stop()");
                    vapi.stop();
                }
            }
        });

        // Listen for messages from the assistant
        vapi.on("message", (message) => {
            console.log("Assistant: Received message:", message);

            // Process the message
            if (message.type === 'transcript' && message.transcriptType === 'final') {
                let transcription = message.transcript;
                let role = message.role; // 'user' or 'assistant'

                console.log("Assistant: Sending transcription:", transcription, "Role:", role);

                // Send the transcription and role to the parent window
                window.parent.postMessage({
                    type: 'transcription',
                    data: {
                        transcription: transcription,
                        role: role
                    }
                }, parentOrigin);
            }
        });

        // Handle errors from the assistant
        vapi.on("error", (e) => {
            console.error("Assistant: Error:", e);
            window.parent.postMessage({
                type: 'error',
                data: e.message || e
            }, parentOrigin);
        });

        // Optional: Listen for call start and end events
        vapi.on("call-start", () => {
            console.log("Assistant: Call has started.");
        });

        vapi.on("call-end", () => {
            console.log("Assistant: Call has ended.");
        });
    </script>
</body>
</html>
