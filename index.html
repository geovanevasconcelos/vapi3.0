<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vapi AI Assistant</title>
    <!-- Include the Vapi SDK -->
    <script src="https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js"></script>
</head>
<body>
    <script>
        var vapiInstance = null;

        function getQueryParam(param) {
            let urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Retrieve parameters from the query string
        const apiKey = getQueryParam('apiKey') || '<your_public_api_key>';
        const assistant = getQueryParam('assistant') || '<assistant_id>';
        const title = getQueryParam('title') || 'Have a quick question?';
        const subtitle = getQueryParam('subtitle') || 'Talk with our AI assistant';
        const parentOrigin = getQueryParam('parentOrigin') || '*';

        // Configure the button
        const buttonConfig = {
            position: "bottom-right",
            offset: "40px",
            width: "50px",
            height: "50px",
            idle: {
                color: `rgb(93, 254, 202)`,
                type: "pill",
                title: title,
                subtitle: subtitle,
                icon: `https://unpkg.com/lucide-static@0.321.0/icons/phone.svg`,
            },
            loading: {
                color: `rgb(93, 124, 202)`,
                type: "pill",
                title: "Connecting...",
                subtitle: "Please wait",
                icon: `https://unpkg.com/lucide-static@0.321.0/icons/loader-2.svg`,
            },
            active: {
                color: `rgb(255, 0, 0)`,
                type: "pill",
                title: "Call is in progress...",
                subtitle: "End the call.",
                icon: `https://unpkg.com/lucide-static@0.321.0/icons/phone-off.svg`,
            },
        };

        // Initialize the assistant when the SDK is loaded
        window.addEventListener('load', function() {
            if (window.vapiEventListenersAdded) {
                return;
            }
            window.vapiEventListenersAdded = true;

            // Initialize vapiInstance using the web snippet approach
            vapiInstance = window.vapiSDK.run({
                apiKey: apiKey, // Mandatory
                assistant: assistant, // Mandatory
                config: buttonConfig, // Optional
            });

            console.log("Assistant: vapiInstance created:", vapiInstance);

            // Add event listeners to vapiInstance for call status updates
            vapiInstance.on('call-start', () => {
                console.log('Assistant: Call has started');
                sendCallStatusToParent(true); // Call is active
            });

            vapiInstance.on('call-end', () => {
                console.log('Assistant: Call has ended');
                sendCallStatusToParent(false); // Call is inactive
            });

            vapiInstance.on('error', (e) => {
                console.error("Assistant: Error:", e);
                window.parent.postMessage({
                    type: 'error',
                    data: e.message || e
                }, parentOrigin);
            });

            // Event listener for messages from the parent window
            window.addEventListener('message', function(event) {
                // Ignore messages from the assistant's own origin
                if (event.origin === window.location.origin) {
                    return;
                }

                if (event.origin !== parentOrigin) {
                    console.warn("Received message from unknown origin:", event.origin);
                    return;
                }

                var data = event.data;
                if (typeof data === 'object' && data !== null) {
                    if (data.type === 'start_conversation') {
                        console.log("Assistant: Starting conversation");
                        simulateButtonClick('start');
                    } else if (data.type === 'stop_conversation') {
                        console.log("Assistant: Stopping conversation");
                        simulateButtonClick('stop');
                    }
                }
            });

            // Function to send call status updates to the parent window
            function sendCallStatusToParent(isCallActive) {
                window.parent.postMessage({
                    type: 'call_status',
                    data: isCallActive
                }, parentOrigin);
            }

            // Function to simulate a click on the assistant button
            function simulateButtonClick(action) {
                var assistantButton = document.querySelector('button[class*="vapi-btn"]');
                if (assistantButton) {
                    assistantButton.click();
                    console.log("Assistant button clicked to " + action + " conversation");
                } else {
                    console.warn("Assistant button not found, retrying in 500ms...");
                    setTimeout(function() {
                        simulateButtonClick(action);
                    }, 500);
                }
            }

            // Existing message listener
            vapiInstance.on('message', (message) => {
                console.log("Assistant: Received message:", message);

                if (message.type === 'transcript' && message.transcriptType === 'final') {
                    let transcription = message.transcript;
                    let role = message.role; // 'user' or 'assistant'

                    console.log("Assistant: Sending transcription:", transcription, "Role:", role);

                    // Send the transcription and role to the parent window
                    window.parent.postMessage({
                        type: 'transcription',
                        data: {
                            transcription: transcription,
                            role: role
                        }
                    }, parentOrigin);
                }
            });
        });
    </script>
</body>
</html>
